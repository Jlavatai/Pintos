\documentclass[a4wide, 11pt]{article}
\usepackage{a4, fullpage}
\usepackage[margin=2.5cm]{geometry}
\newcommand{\tx}{\texttt}

\begin{document}
\title{Pintos Task 3 : Virtual Memory}
\author{Francesco Di Mauro, Thomas Rooney, Alex Rozanski}

\maketitle

\section{Page Table Management}
\subsection{Data structures}
\subsubsection{A1}
Added to \tx{struct thread} in \tx{thread.h}:
\begin{verbatim}
struct hash supplemental_page_table;
\end{verbatim}
Hash table representing the supplemental page table.
Added to new file \tx{page.h}:
\begin{verbatim}
enum page_status {
   PAGE_UNDEFINED = 0,           /*default status*/
   PAGE_FILESYS = 1 << 0,        /*page referring to a file*/
   PAGE_SWAP  = 1 << 1,          /*page in the swap partition*/
   PAGE_MEMORY_MAPPED  = 1 << 2, /*page representing a mem mapd file*/
   PAGE_IN_MEMORY = 1 << 3,      /*page currently stored in memory*/
   PAGE_ZERO = 1 << 4,           /*page of zero bytes*/
};
\end{verbatim}
Enum used to represent the status of a page in the supplemental page table.

\begin{verbatim}
struct page_filesys_info {
   struct file *file;
   size_t offset;
};
\end{verbatim}
If a page refers to a file in the file system, it will store info regarding the actual file in memory.


\begin{verbatim}
struct page {
   struct hash_elem hash_elem;		/* Used to store the frame in the page table. */
   void *vaddr;	    			/* The address of the page in user virtual memory. */
   void *aux;						/* */
   enum page_status page_status;   /* Used to store the page's current status. */
   bool writable;					/* Stores if a page is writable or not */
};
\end{verbatim}
Struct holding information about a page, stored in the supplemental page table.

 

\subsection{Algorithms}
\subsubsection{A2}
The location of a frame is handled mainly via the supplemental page table.
When an executable is loaded, the new function \tx{load\_executable\_page} is called. This function will take care of analysing the content of the segment that should be loaded, and instead of bringing it directly into memory, thus allocating a frame, it adds a mapping a the supplemental page table, setting the field \tx{page\_status} to the status needed depending on the nature of the segment. \\
Upon page fault, the supplemental page table is consulted: if an entry is not present, the OS decides whether it is a memory access that requires a stack growth. But if an entry is found, then, at first, the function \tx{frame\_allocator\_get\_user\_page} is called. This function will, in turn, call \tx{palloc\_get\_page}, which will retrieve a frame from the user pool, add a page table entry for this page - frame mapping in the page table, and return the page's address. The additional work that \tx{frame\_allocator\_get\_user\_page} carries out is to create a \tx{struct frame}, recording the address of the allocated frame, the address of the page  mapped, the \tx{tid\_t} of the thread owning the frame, and then adding this struct to the frame table. The frame will then be filled with the correct information: it will be zeroed, or the content of a file in the file system will be copied \\
Before returning from the page fault handler, the page will me marked as present in memory in the supplemental page table.
\subsubsection{A3}

\subsection{Synchronization}
\subsubsection{A4}

\subsection{Rationale}
\subsubsection{A5}

\section{Paging to and from disk}

\subsection{Data structures}
\subsubsection{B1}

\subsection{Algorithms}
\subsubsection{B2}

\subsubsection{B3}

\subsection{B4}

\subsection{Synchronization}
\subsubsection{B5}

\subsubsection{B6}

\subsubsection{B7}

\subsubsection{B8}

\subsection{Rationale}
\subsubsection{B9}


\section{Memory Mapped Files}
\subsection{Data structures}
\subsubsection{C1}
\begin{verbatim}
struct page_mmap_info {
   mapid_t mapping;				/* The mmap() mapid. */
   size_t offset;					/* The offset into the file. */
   size_t length;					/* The number of bytes of the file stored in this page. */
};
\end{verbatim}
If a page represents a file mapped in memory, this struct will hold information about the id of the mapping, offset in the file and length of the file.

\subsection{Algorithms}
\subsubsection{C2}

\subsubsection{C3}

\subsection{Rationale}
\subsubsection{C4}

\end{document}